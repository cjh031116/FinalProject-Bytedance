<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/app/src/main/java/com/example/finalwork/MainActivity.kt">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/app/src/main/java/com/example/finalwork/MainActivity.kt" />
              <option name="originalContent" value="package com.example.finalwork&#10;&#10;import android.os.Bundle&#10;import android.os.Handler&#10;import android.os.Looper&#10;import androidx.appcompat.app.AppCompatActivity&#10;import androidx.recyclerview.widget.LinearLayoutManager&#10;import androidx.recyclerview.widget.PagerSnapHelper&#10;import androidx.recyclerview.widget.RecyclerView&#10;&#10;class MainActivity : AppCompatActivity() {&#10;&#10;    private lateinit var recyclerView: RecyclerView&#10;    private lateinit var adapter: VideoFeedAdapter&#10;    private val dataSource = VideoRepository()&#10;    private val handler = Handler(Looper.getMainLooper())&#10;&#10;    override fun onCreate(savedInstanceState: Bundle?) {&#10;        super.onCreate(savedInstanceState)&#10;        setContentView(R.layout.activity_main)&#10;        supportActionBar?.hide()&#10;&#10;        //layoutmanager来设置滑动样式&#10;        recyclerView = findViewById(R.id.rv_videos)&#10;        val layoutManager = LinearLayoutManager(this, RecyclerView.VERTICAL, false)&#10;        recyclerView.layoutManager = layoutManager&#10;&#10;        //总能找到一个完全可见的视频项来播放&#10;        val snapHelper = PagerSnapHelper()&#10;        snapHelper.attachToRecyclerView(recyclerView)&#10;&#10;        //配置好适配器&#10;        adapter = VideoFeedAdapter(this)&#10;        recyclerView.adapter = adapter&#10;&#10;        adapter.submitList(dataSource.loadInitial())&#10;&#10;        recyclerView.addOnScrollListener(object : RecyclerView.OnScrollListener() {&#10;            override fun onScrollStateChanged(recyclerView: RecyclerView, newState: Int) {&#10;                super.onScrollStateChanged(recyclerView, newState)&#10;                if (newState == RecyclerView.SCROLL_STATE_IDLE) {&#10;                    autoPlayCurrentVisible()&#10;                }&#10;&#10;                if (!recyclerView.canScrollVertically(1)) {&#10;                    loadMore()&#10;                }&#10;            }&#10;        })&#10;&#10;        recyclerView.post { autoPlayCurrentVisible() }&#10;    }&#10;&#10;    private fun autoPlayCurrentVisible() {&#10;        val layoutManager = recyclerView.layoutManager as? LinearLayoutManager ?: return&#10;        val position = layoutManager.findFirstCompletelyVisibleItemPosition()&#10;            .takeIf { it != RecyclerView.NO_POSITION }&#10;            ?: layoutManager.findFirstVisibleItemPosition()&#10;&#10;        if (position == RecyclerView.NO_POSITION) return&#10;&#10;        adapter.playVideoAt(position, recyclerView)&#10;    }&#10;&#10;    private fun loadMore() {&#10;        handler.postDelayed({ //防抖&#10;            val more = dataSource.loadMore()&#10;            if (more.isNotEmpty()) {&#10;                adapter.appendList(more)&#10;            }&#10;        }, 500)&#10;    }&#10;&#10;    override fun onPause() {&#10;        super.onPause()&#10;        adapter.pauseCurrent()&#10;    }&#10;&#10;    override fun onDestroy() {&#10;        super.onDestroy()&#10;        adapter.release()&#10;        handler.removeCallbacksAndMessages(null) //针对handler.postDelayed 防止内存泄漏，移除所有待处理的回调和消息&#10;        CacheUtil.releaseCache()&#10;    }&#10;}&#10;" />
              <option name="updatedContent" value="package com.example.finalwork&#10;&#10;import android.os.Bundle&#10;import android.os.Handler&#10;import android.os.Looper&#10;import android.util.Log&#10;import android.widget.Toast&#10;import androidx.appcompat.app.AppCompatActivity&#10;import androidx.recyclerview.widget.LinearLayoutManager&#10;import androidx.recyclerview.widget.PagerSnapHelper&#10;import androidx.recyclerview.widget.RecyclerView&#10;&#10;class MainActivity : AppCompatActivity() {&#10;&#10;    private lateinit var recyclerView: RecyclerView&#10;    private lateinit var adapter: VideoFeedAdapter&#10;    private val dataSource = VideoRepository()&#10;    private val handler = Handler(Looper.getMainLooper())&#10;&#10;    companion object {&#10;        private const val TAG = &quot;MainActivity&quot;&#10;        // ⚠️ 测试开关：改为 false 测试&quot;优化前&quot;，改为 true 测试&quot;优化后&quot;&#10;        private const val ENABLE_PRELOAD = true&#10;    }&#10;&#10;    override fun onCreate(savedInstanceState: Bundle?) {&#10;        super.onCreate(savedInstanceState)&#10;        setContentView(R.layout.activity_main)&#10;        supportActionBar?.hide()&#10;&#10;        // 显示当前测试模式&#10;        val testMode = if (ENABLE_PRELOAD) &quot;启用预加载&quot; else &quot;禁用预加载&quot;&#10;        Toast.makeText(this, &quot;测试模式: $testMode&quot;, Toast.LENGTH_LONG).show()&#10;        Log.i(TAG, &quot;========================================&quot;)&#10;        Log.i(TAG, &quot;应用启动 - 测试模式: $testMode&quot;)&#10;        Log.i(TAG, &quot;========================================&quot;)&#10;&#10;        //layoutmanager来设置滑动样式&#10;        recyclerView = findViewById(R.id.rv_videos)&#10;        val layoutManager = LinearLayoutManager(this, RecyclerView.VERTICAL, false)&#10;        recyclerView.layoutManager = layoutManager&#10;&#10;        //总能找到一个完全可见的视频项来播放&#10;        val snapHelper = PagerSnapHelper()&#10;        snapHelper.attachToRecyclerView(recyclerView)&#10;&#10;        //配置好适配器 - 传入预加载开关&#10;        adapter = VideoFeedAdapter(this, enablePreload = ENABLE_PRELOAD)&#10;        recyclerView.adapter = adapter&#10;&#10;        adapter.submitList(dataSource.loadInitial())&#10;&#10;        recyclerView.addOnScrollListener(object : RecyclerView.OnScrollListener() {&#10;            override fun onScrollStateChanged(recyclerView: RecyclerView, newState: Int) {&#10;                super.onScrollStateChanged(recyclerView, newState)&#10;                if (newState == RecyclerView.SCROLL_STATE_IDLE) {&#10;                    autoPlayCurrentVisible()&#10;                }&#10;&#10;                if (!recyclerView.canScrollVertically(1)) {&#10;                    loadMore()&#10;                }&#10;            }&#10;        })&#10;&#10;        recyclerView.post { autoPlayCurrentVisible() }&#10;    }&#10;&#10;    private fun autoPlayCurrentVisible() {&#10;        val layoutManager = recyclerView.layoutManager as? LinearLayoutManager ?: return&#10;        val position = layoutManager.findFirstCompletelyVisibleItemPosition()&#10;            .takeIf { it != RecyclerView.NO_POSITION }&#10;            ?: layoutManager.findFirstVisibleItemPosition()&#10;&#10;        if (position == RecyclerView.NO_POSITION) return&#10;&#10;        adapter.playVideoAt(position, recyclerView)&#10;    }&#10;&#10;    private fun loadMore() {&#10;        handler.postDelayed({ //防抖&#10;            val more = dataSource.loadMore()&#10;            if (more.isNotEmpty()) {&#10;                adapter.appendList(more)&#10;            }&#10;        }, 500)&#10;    }&#10;&#10;    override fun onPause() {&#10;        super.onPause()&#10;        adapter.pauseCurrent()&#10;    }&#10;&#10;    override fun onDestroy() {&#10;        super.onDestroy()&#10;        &#10;        // 输出完整性能报告&#10;        Log.i(TAG, &quot;\n&quot; + adapter.getPerformanceReport())&#10;        &#10;        adapter.release()&#10;        handler.removeCallbacksAndMessages(null) //针对handler.postDelayed 防止内存泄漏，移除所有待处理的回调和消息&#10;        CacheUtil.releaseCache()&#10;    }&#10;}&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/快速测试指南.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/快速测试指南.md" />
              <option name="updatedContent" value="# 快速测试指南&#10;&#10;##  测试步骤&#10;&#10;### 测试 1：禁用预加载（基准测试）&#10;&#10;1. 打开 `MainActivity.kt`，修改第 20 行：&#10;   ```kotlin&#10;   private const val ENABLE_PRELOAD = false  // 改为 false&#10;   ```&#10;&#10;2. 清除应用数据（手机设置 -&gt; 应用 -&gt; FinalWork -&gt; 清除数据）&#10;&#10;3. 运行应用，滑动 10 个视频&#10;&#10;4. 关闭应用，在 Logcat 搜索 `VideoPerformance`，复制最后的报告&#10;&#10;---&#10;&#10;### 测试 2：启用预加载（优化测试）&#10;&#10;1. 打开 `MainActivity.kt`，修改第 20 行：&#10;   ```kotlin&#10;   private const val ENABLE_PRELOAD = true  // 改为 true&#10;   ```&#10;&#10;2. 清除应用数据&#10;&#10;3. 运行应用，滑动 10 个视频&#10;&#10;4. 关闭应用，在 Logcat 复制报告&#10;&#10;---&#10;&#10;##  对比数据&#10;&#10;将两次测试的报告整理成表格即可！&#10;&#10;### 预期效果：&#10;- **优化前**：平均加载 1000-1500ms，缓存命中率 0%&#10;- **优化后**：平均加载 200-400ms，缓存命中率 60-70%&#10;- **提升**：约 70-80% 性能提升&#10;&#10;---&#10;&#10;##  查看日志&#10;&#10;在 Android Studio 底部 Logcat 中搜索：`VideoPerformance`&#10;&#10;你会看到详细的加载日志和最终报告！&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>